{
  order authenticate before respond
  order authorize before reverse_proxy

  acme_dns digitalocean {env.DO_AUTH_TOKEN}

  security {
    oauth identity provider google {
      realm google
      driver google
      client_id {env.GOOGLE_CLIENT_ID}
      client_secret {env.GOOGLE_CLIENT_SECRET}
      scopes openid email profile
    }

    authentication portal myportal {
      crypto default token lifetime 3600
      crypto key sign-verify {env.JWT_SHARED_KEY}
      enable identity provider google
      cookie domain {env.CADDY_DOMAIN}

      ui {
        links {
          "My Identity" "/whoami" icon "las la-user"
        }
      }

      transform user {
        match realm google
        action add role authp/user
        ui link "NVR" https://{$CADDY_SUBDOMAIN}.{$CADDY_DOMAIN}/ icon "las la-star"
      }

      transform user {
        match realm google
        match email {env.CADDY_ADMIN}
        action add role authp/admin
      }
    }

    authorization policy mypolicy {
      set auth url https://auth.{$CADDY_DOMAIN}/oauth2/google
      crypto key verify {env.JWT_SHARED_KEY}
      allow roles authp/admin authp/user
      validate bearer header
      inject headers with claims
    }
  }
}

(https_header) {
  header {
    Strict-Transport-Security "max-age=31536000; includeSubdomains"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "same-origin"
  }
}

auth.{$CADDY_DOMAIN} {
  encode gzip
  authenticate with myportal
}

{$CADDY_SUBDOMAIN}.{$CADDY_DOMAIN} {
  encode gzip

  #import https_header

  @remote_host_filter {
    not remote_ip 192.168.1.101
    not remote_ip 100.120.36.116
    not path /caddy-health-check
  }

  handle @remote_host_filter {
    authorize with mypolicy
  }

  respond /caddy-health-check 200

  rewrite /cockpit /cockpit/

  reverse_proxy /cockpit/* https://host.docker.internal:9090 {
    transport http {
      tls_insecure_skip_verify
    }
  }

  reverse_proxy {$CADDY_PROXY_UPSTREAM}
}
